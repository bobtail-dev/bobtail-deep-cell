{"version":3,"sources":["../src/main.js"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["import nn from 'nevernull';\nimport _ from 'underscore';\nimport * as rx from 'bobtail-rx';\nimport deepGet from 'lodash.get';\nimport deepSet from 'lodash.set';\nimport deepHas from 'lodash.hasin';\n\nimport patchFactory from 'jsondiffpatch';\n\nlet jsondiffpatch = patchFactory.create({\n//  objectHash: (obj) -> obj.name or obj.id or obj._id\n  cloneDiffValues: true\n});\n\nlet recorder = rx._recorder;\n\nexport let patchHas = function(patch, path, diffArray=false) {\n  if(_.isString(path)) {\n    return patchHas(patch, path.split('.'));  // potentially ambiguous with empty or dot-containing property names\n  }\n  if(!path.length) {return true;}\n  if (_.isArray(patch) && !diffArray) {\n    diffArray = true;\n    patch = patch[0];\n  }\n\n  let [first, ...rest] = path;\n\n  if (_.isObject(patch)) {\n    if (!diffArray && patch._t === 'a') {\n      let under = `${first}`;\n      if(under in patch) {\n        return patchHas(patch[under], rest, diffArray);\n      }\n      else if(first in patch) {\n        return patchHas(patch[first], rest, diffArray);\n      }\n      return false;\n    }\n    if (!(first in patch)) {\n      return false;\n    } else if (path.length === 1) {\n      return true;\n    }\n    return patchHas(patch[first], rest, diffArray);\n  }\n  return false;\n};\n\nlet prefixDiff = function(basePath, diff) {\n  if (!basePath.length) { return diff; }\n  let x = {};\n  deepSet(x, basePath, diff);\n  return x;\n};\n\nexport function logReturn(x) {\n  console.info(x);\n  return x;\n}\n\nlet lengthChange = patchVal =>\n  _.isArray(patchVal) && ((patchVal.length === 1) || (patchVal[1] === 0 && patchVal[2] === 0));\n\nexport let UPDATE = Symbol('update');\n\nexport class JsonCell extends rx.ObsBase {\n  constructor(_base) {\n    super();\n    this._base = _base != null ? _base: {};\n    this.onChange = this._mkEv(() => jsondiffpatch.diff({}, this._base));\n    this.onUnsafeMutation = this._mkEv(() => {});\n    this._data = new Proxy(this._base, this.conf([], null));\n  }\n\n  get data() {return this._data;}\n  set data(val) {this.update(val);}\n\n  static stDel(obj, prop) {return delete obj[prop];}\n  del(obj, prop) {return this.__proto__.constructor.stDel(obj, prop);}\n  static stSet(obj, prop, val) {return obj[prop] = val;}\n  set(obj, prop) {return this.__proto__.constructor.stSet(obj, prop);}\n\n  update (newVal) {\n    let diff = jsondiffpatch.diff(this.data, newVal);\n    jsondiffpatch.patch(this.data, diff);\n    return true;\n  }\n\n  conf(basePath) {\n    let getPath = (...props) => basePath.concat(props);\n\n    return {\n      deleteProperty: (obj, prop) => {\n        let path = getPath(prop);\n        if (recorder.stack.length > 0) {\n          // the default mutation warning is nowhere near dire enough. mutating nested objects within a\n          // bind is extremely likely to lead to infinite loops.\n          console.warn(\n            `Warning: deleting nested element at ${path.join('.')} from within a bind context. Affected object:`, obj\n          );\n          this.onUnsafeMutation.pub({op: 'delete', path, obj, prop, base: this._base})\n        }\n        recorder.mutating(() => {\n          let old = obj[prop];\n          let diff = prefixDiff(basePath, [{[prop]: old}, 0, 0]);\n          if(prop in obj) {\n            this.del(obj, prop);\n            this.onChange.pub(diff);\n          }\n        });\n        return true;\n      },\n      set: (obj, prop, val) => {\n        let path = getPath(prop);\n        if (recorder.stack.length > 0) {\n          // the default mutation warning is nowhere near dire enough. mutating nested objects within a\n          // bind is extremely likely to lead to infinite loops.\n          console.warn(\n            `Warning: updating nested element at ${path.join('.')} from within a bind context. Affected object:`, obj\n          );\n          this.onUnsafeMutation.pub({op: 'set', path, obj, prop, val, base: this._base});\n        }\n        recorder.mutating(() => {\n          let old = rx.snap(() => obj[prop]);\n          let diff = jsondiffpatch.diff({[prop]: old}, {[prop]: val});\n          if (diff) {\n            rx.snap(() => jsondiffpatch.patch(obj, diff));\n            this.onChange.pub(prefixDiff(basePath, diff));\n          }\n        });\n        return true;\n      },\n      get: (obj, prop) => {\n        let val = obj[prop];\n        if (prop === '__proto__' || _.isFunction(val)) {\n          return val;\n        }\n        if (prop === UPDATE || (prop === 'updateRxb' && !('updateRxb' in obj))) {\n          return other => jsondiffpatch.patch(obj, jsondiffpatch.diff(obj, other));\n        }\n        let path = getPath(prop);\n        if (prop === 'length' && _.isArray(obj)) {\n          let oldVal = obj.length;\n          recorder.sub(this.onChange, () => {\n            let newVal = deepGet(this._base, path);\n            if(newVal !== oldVal){\n              oldVal = newVal;\n              return true;\n            }\n            return false;\n          });\n        }\n        else {\n          recorder.sub(this.onChange, patch => patchHas(patch, path));\n        }\n        // return new Proxy(deepGet(this._base, path), this.conf(path, obj));\n        if (_.isObject(val)) {\n          return new Proxy(val, this.conf(getPath(prop), obj));\n        }\n        return val;\n      },\n      has: (obj, prop) => {\n        let path = getPath(prop);\n        let had = prop in obj;\n        recorder.sub(this.onChange, patch => {\n          let has = deepHas(this._base, path);\n          if(had !== has) {\n            had = has;\n            return true;\n          }\n          return false;\n        });\n        return had;\n      },\n      ownKeys: obj => {\n        recorder.sub(this.onChange, patch => {\n          let delta = deepGet(patch, basePath);\n          if (!delta) {\n            return false;\n          }\n          // if we added or removed fields on this object\n          if (_.isArray(delta && (delta.length !== 2))) {\n            return true;\n          }\n          // true if we added or removed elements to this array, else false\n          return (delta._t === 'a') && _.chain(delta).omit('_t').values().value().some(\n\n          );\n        });\n\n        return Reflect.ownKeys(obj);\n      }\n    }\n  }\n}\n\nexport let jsonCell = _base => new JsonCell(_base).data;\n\nexport let update = (cell, newVal) => {\n  let diff = jsondiffpatch.diff(cell, newVal);\n  jsondiffpatch.patch(cell, diff);\n  return true;\n};"]}