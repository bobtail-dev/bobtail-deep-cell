{"version":3,"sources":["../src/main.js"],"names":[],"mappings":"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","file":"main.js","sourcesContent":["import _ from 'underscore';\nimport * as rx from 'bobtail-rx';\nimport deepGet from 'lodash.get';\nimport deepSet from 'lodash.set';\nimport deepHas from 'lodash.hasin';\n\nimport patchFactory from 'jsondiffpatch';\n\nlet jsondiffpatch = patchFactory.create({\n//  objectHash: (obj) -> obj.name or obj.id or obj._id\n  cloneDiffValues: true\n});\n\nlet recorder = rx._recorder;\n\nexport let patchHas = function(patch, path, diffArray=false) {\n  if(_.isString(path)) {\n    return patchHas(patch, path.split('.'));  // potentially ambiguous with empty or dot-containing property names\n  }\n  if(!path.length) {return true;}\n  if (_.isArray(patch) && !diffArray) {\n    diffArray = true;\n    patch = patch[0];\n  }\n\n  let [first, ...rest] = path;\n\n  if (_.isObject(patch)) {\n    if (!diffArray && patch._t === 'a') {\n      let under = `${first}`;\n      if(under in patch) {\n        return patchHas(patch[under], rest, diffArray);\n      }\n      else if(first in patch) {\n        return patchHas(patch[first], rest, diffArray);\n      }\n      return false;\n    }\n    if (!(first in patch)) {\n      return false;\n    } else if (path.length === 1) {\n      return true;\n    }\n    return patchHas(patch[first], rest, diffArray);\n  }\n  return false;\n};\n\nlet prefixDiff = function(basePath, diff) {\n  if (!basePath.length) { return diff; }\n  let x = {};\n  deepSet(x, basePath, diff);\n  return x;\n};\n\nexport function logReturn(x) {\n  console.info(x);\n  return x;\n}\n\nlet lengthChange = patchVal =>\n  _.isArray(patchVal) && ((patchVal.length === 1) || (patchVal[1] === 0 && patchVal[2] === 0));\n\nexport let UPDATE = Symbol('update');\n\nfunction deleteProperty (getPath, basePath, obj, prop) {\n  return rx.snap(() => {\n    let path = getPath(prop);\n    if (recorder.stack.length > 0) {\n      // the default mutation warning is nowhere near dire enough. mutating nested objects within a\n      // bind is extremely likely to lead to infinite loops.\n      console.warn(\n        `Warning: deleting nested element at ${path.join('.')} from within a bind context. Affected object:`, obj\n      );\n      this.onUnsafeMutation.pub({op: 'delete', path, obj, prop, base: this._base})\n    }\n    recorder.mutating(() => {\n      let old = obj[prop];\n      let diff = prefixDiff(basePath, [{[prop]: old}, 0, 0]);\n      if(prop in obj) {\n        delete obj[prop];\n        this.onChange.pub(diff);\n      }\n    });\n    return true;\n  })\n}\n\nfunction setProperty (getPath, basePath, obj, prop, val) {\n  return rx.snap(() => {\n    let path = getPath(prop);\n    if (recorder.stack.length > 0) {\n      // the default mutation warning is nowhere near dire enough. mutating nested objects within a\n      // bind is extremely likely to lead to infinite loops.\n      console.warn(\n        `Warning: updating nested element at ${path.join('.')} from within a bind context. Affected object:`, obj\n      );\n      this.onUnsafeMutation.pub({op: 'set', path, obj, prop, val, base: this._base});\n    }\n    recorder.mutating(() => {\n      let old = rx.snap(() => obj[prop]);\n      let diff = jsondiffpatch.diff({[prop]: old}, {[prop]: val});\n      if (diff) {\n        jsondiffpatch.patch(obj, diff);\n        this.onChange.pub(prefixDiff(basePath, diff));\n      }\n    });\n    return true;\n  })\n}\n\nfunction getProperty(getPath, basePath, obj, prop) {\n  let val = obj[prop];\n  if (prop === '__proto__' || _.isFunction(val)) {\n    return val;\n  }\n  if (prop === UPDATE || (prop === 'updateRxb' && !('updateRxb' in obj))) {\n    return other => jsondiffpatch.patch(obj, jsondiffpatch.diff(obj, other));\n  }\n  let path = getPath(prop);\n  if (prop === 'length' && _.isArray(obj)) {\n    let oldVal = obj.length;\n    recorder.sub(this.onChange, () => {\n      let newVal = deepGet(this._base, path.slice(1));  // necessary because of wrapping in value field\n      if(newVal !== oldVal){\n        oldVal = newVal;\n        return true;\n      }\n      return false;\n    });\n  }\n  else {\n    recorder.sub(this.onChange, patch => patchHas(patch, path));\n  }\n  // return new Proxy(deepGet(this._base, path), this.conf(path, obj));\n  if (_.isObject(val)) {\n    return new Proxy(val, this.conf(getPath(prop), obj));\n  }\n  return val;\n}\n\nexport class ObsJsonCell extends rx.ObsBase {\n  constructor(_base) {\n    super();\n    this._base = _base;\n    this.onChange = this._mkEv(() => jsondiffpatch.diff({}, this._base));\n    this.onUnsafeMutation = this._mkEv(() => {});\n    this._updating(() => this._data = new Proxy({value: this._base}, this.conf([], null)));\n  }\n\n  _updating (f) {\n    this._oldUpdating = this._nowUpdating || false;\n    this._nowUpdating = true;\n    try {rx.snap(f);}\n    finally {this._nowUpdating = this._oldUpdating;}\n    return true;\n  }\n\n  _update (newVal) {\n    this._updating(() => {\n      let diff = jsondiffpatch.diff(this._data, {value: newVal});\n      jsondiffpatch.patch(this._data, diff);\n    });\n    return true;\n  }\n\n  all () {return this.data;}\n  readonly () {return new DepJsonCell(() => this.data)}\n\n  get data() {return this._data.value;}\n\n  mkDeleteProperty (getPath, basePath) {\n    return (obj, prop) => this.deleteProperty(getPath, basePath, obj, prop);\n  }\n\n  mkSetProperty (getPath, basePath) {\n    return (obj, prop, val) => this.setProperty(getPath, basePath, obj, prop, val);\n  }\n\n  mkGetProperty (getPath, basePath) {\n    return (obj, prop) => this.getProperty(getPath, basePath, obj, prop);\n  }\n\n  deleteProperty (getPath, basePath, obj, prop) {\n    return deleteProperty.call(this, getPath, basePath, obj, prop);\n  }\n\n  setProperty (getPath, basePath, obj, prop, val) {\n    return setProperty.call(this, getPath, basePath, obj, prop, val);\n  }\n\n  getProperty (getPath, basePath, obj, prop) {\n    return getProperty.call(this, getPath, basePath, obj, prop);\n  }\n\n  _makeReadOnly() {\n    let oldSet = this.setProperty;\n    this.setProperty = function(getPath, basePath, obj, prop, val) {\n      if (!this._nowUpdating) {\n        throw new DepMutationError(\"Cannot mutate DepJsonCell!\");\n      }\n      else return oldSet.call(this, getPath, basePath, obj, prop, val);\n    };\n\n    let oldDelete = this.deleteProperty;\n    this.deleteProperty = function (getPath, basePath, obj, prop) {\n      if (!this._nowUpdating) {\n        throw new DepMutationError(\"Cannot mutate DepJsonCell!\");\n      }\n      else return oldDelete.call(this, getPath, basePath, obj, prop);\n    };\n    return this;\n  }\n\n  conf(basePath) {\n    let getPath = (...props) => basePath.concat(props);\n\n    return {\n      deleteProperty: this.mkDeleteProperty(getPath, basePath),\n      set: this.mkSetProperty(getPath, basePath),\n      get: this.mkGetProperty(getPath, basePath),\n      has: (obj, prop) => {\n        let path = getPath(prop).slice(1);  // necessary because we wrap within the value field.\n        let had = prop in obj;\n        recorder.sub(this.onChange, patch => {\n          let has = deepHas(this._base, path);\n          if(had !== has) {\n            had = has;\n            return true;\n          }\n          return false;\n        });\n        return had;\n      },\n      ownKeys: obj => {\n        recorder.sub(this.onChange, patch => {\n          let delta = deepGet(patch, basePath);\n          if (!delta) {\n            return false;\n          }\n          // if we added or removed fields on this object\n          if (_.isArray(delta && (delta.length !== 2))) {\n            return true;\n          }\n          // true if we added or removed elements to this array, else false\n          return (delta._t === 'a') && _.chain(delta).omit('_t').values().value().some();\n        });\n\n        return Reflect.ownKeys(obj);\n      }\n    }\n  }\n}\n\nexport class DepMutationError extends Error {\n  // https://stackoverflow.com/questions/31089801/extending-error-in-javascript-with-es6-syntax\n  constructor(...args) {\n    super(...args);\n    Error.captureStackTrace(this, DepMutationError)\n  }\n}\n\nexport class DepJsonCell extends ObsJsonCell {\n  constructor(f, init = {}) {\n    super(init);\n    this.f = f;\n    let c = rx.bind(this.f);\n    rx.autoSub(c.onSet, ([o, n]) => this._update(n));\n    this._makeReadOnly();\n  }\n}\n\nexport class SrcJsonCell extends ObsJsonCell {\n  constructor (init) {super(init);}\n  update(val) {return this._update(val);}\n  set data(val) {this._update(val);}\n  get data() {return this._data.value;}\n}\n\nexport let jsonCell = _base => new SrcJsonCell(_base).data;\n\nexport let update = (cell, newVal) => rx.snap(() => {\n  let diff = jsondiffpatch.diff(cell, newVal);\n  jsondiffpatch.patch(cell, diff);\n  return true;\n});"]}