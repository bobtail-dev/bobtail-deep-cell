!function(e,n){if("function"==typeof define&&define.amd)define("bobtail-json-cell",["exports","underscore","bobtail-rx","lodash.get","lodash.set","lodash.hasin","jsondiffpatch"],n);else if("undefined"!=typeof exports)n(exports,require("underscore"),require("bobtail-rx"),require("lodash.get"),require("lodash.set"),require("lodash.hasin"),require("jsondiffpatch"));else{var t={exports:{}};n(t.exports,e._,e.rx,e.lodashGet,e.lodashSet,e.lodashHasin,e.jsondiffpatch),e.bobtailJsonCell=t.exports}}(this,function(e,n,t,r,o,a,u){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function f(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function l(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function c(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}function d(e){return Array.isArray(e)?e:Array.from(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.update=e.jsonCell=e.JsonCell=e.UPDATE=e.patchHas=void 0,e.logReturn=function(e){return console.info(e),e};var p=i(n),h=function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(n[t]=e[t]);return n.default=e,n}(t),b=i(r),v=i(o),y=i(a),g=i(u),_=function(){function e(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(n,t,r){return t&&e(n.prototype,t),r&&e(n,r),n}}(),j=g.default.create({cloneDiffValues:!0}),w=h._recorder,m=e.patchHas=function e(n,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(p.default.isString(t))return e(n,t.split("."));if(!t.length)return!0;p.default.isArray(n)&&!r&&(r=!0,n=n[0]);var o=d(t),a=o[0],u=o.slice(1);if(p.default.isObject(n)){if(!r&&"a"===n._t){var i=""+a;return i in n?e(n[i],u,r):a in n&&e(n[a],u,r)}return a in n&&(1===t.length||e(n[a],u,r))}return!1},x=function(e,n){if(!e.length)return n;var t={};return(0,v.default)(t,e,n),t},O=e.UPDATE=Symbol("update"),C=e.JsonCell=function(e){function n(e){s(this,n);var t=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return t._base=null!=e?e:{},t.onChange=t._mkEv(function(){return j.diff({},t._base)}),t.onUnsafeMutation=t._mkEv(function(){}),t._data=new Proxy(t._base,t.conf([],null)),t}return c(n,h.ObsBase),_(n,[{key:"update",value:function(e){var n=this;h.snap(function(){var t=j.diff(n.data,e);return j.patch(n.data,t),!0})}},{key:"conf",value:function(e){var n=this,t=function(){for(var n=arguments.length,t=Array(n),r=0;r<n;r++)t[r]=arguments[r];return e.concat(t)};return{deleteProperty:function(r,o){return h.snap(function(){var a=t(o);return w.stack.length>0&&(console.warn("Warning: deleting nested element at "+a.join(".")+" from within a bind context. Affected object:",r),n.onUnsafeMutation.pub({op:"delete",path:a,obj:r,prop:o,base:n._base})),w.mutating(function(){var t=r[o],a=x(e,[f({},o,t),0,0]);o in r&&(delete r[o],n.onChange.pub(a))}),!0})},set:function(r,o,a){return h.snap(function(){var u=t(o);return w.stack.length>0&&(console.warn("Warning: updating nested element at "+u.join(".")+" from within a bind context. Affected object:",r),n.onUnsafeMutation.pub({op:"set",path:u,obj:r,prop:o,val:a,base:n._base})),w.mutating(function(){var t=h.snap(function(){return r[o]}),u=j.diff(f({},o,t),f({},o,a));u&&(j.patch(r,u),n.onChange.pub(x(e,u)))}),!0})},get:function(e,r){var o=e[r];if("__proto__"===r||p.default.isFunction(o))return o;if(r===O||"updateRxb"===r&&!("updateRxb"in e))return function(n){return j.patch(e,j.diff(e,n))};var a=t(r);if("length"===r&&p.default.isArray(e)){var u=e.length;w.sub(n.onChange,function(){var e=(0,b.default)(n._base,a);return e!==u&&(u=e,!0)})}else w.sub(n.onChange,function(e){return m(e,a)});return p.default.isObject(o)?new Proxy(o,n.conf(t(r),e)):o},has:function(e,r){var o=t(r),a=r in e;return w.sub(n.onChange,function(e){var t=(0,y.default)(n._base,o);return a!==t&&(a=t,!0)}),a},ownKeys:function(t){return w.sub(n.onChange,function(n){var t=(0,b.default)(n,e);return!!t&&(!!p.default.isArray(t&&2!==t.length)||"a"===t._t&&p.default.chain(t).omit("_t").values().value().some())}),Reflect.ownKeys(t)}}}},{key:"data",get:function(){return this._data},set:function(e){this.update(e)}}]),n}();e.jsonCell=function(e){return new C(e).data},e.update=function(e,n){return h.snap(function(){var t=j.diff(e,n);return j.patch(e,t),!0})}});