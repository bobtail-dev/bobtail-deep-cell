!function(t,e){if("function"==typeof define&&define.amd)define("bobtail-json-cell",["exports","underscore","bobtail-rx","lodash.get","lodash.set","lodash.hasin","jsondiffpatch"],e);else if("undefined"!=typeof exports)e(exports,require("underscore"),require("bobtail-rx"),require("lodash.get"),require("lodash.set"),require("lodash.hasin"),require("jsondiffpatch"));else{var n={exports:{}};e(n.exports,t._,t.rx,t.lodashGet,t.lodashSet,t.lodashHasin,t.jsondiffpatch),t.bobtailJsonCell=n.exports}}(this,function(t,e,n,r,o,a,u){"use strict";function i(t){return t&&t.__esModule?t:{default:t}}function f(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function s(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function c(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function p(t){return Array.isArray(t)?t:Array.from(t)}function d(t,e,n,r){var o=this;return v.snap(function(){var a=t(r);return k.stack.length>0&&(console.warn("Warning: deleting nested element at "+a.join(".")+" from within a bind context. Affected object:",n),o.onUnsafeMutation.pub({op:"delete",path:a,obj:n,prop:r,base:o._base})),k.mutating(function(){var t=n[r],a=x(e,[c({},r,t),0,0]);r in n&&(delete n[r],o.onChange.pub(a))}),!0})}function h(t,e,n,r,o){var a=this;return v.snap(function(){var u=t(r);return k.stack.length>0&&(console.warn("Warning: updating nested element at "+u.join(".")+" from within a bind context. Affected object:",n),a.onUnsafeMutation.pub({op:"set",path:u,obj:n,prop:r,val:o,base:a._base})),k.mutating(function(){var t=v.snap(function(){return n[r]}),u=P.diff(c({},r,t),c({},r,o));u&&(P.patch(n,u),a.onChange.pub(x(e,u)))}),!0})}function y(t){t.setProperty=function(e,n,r,o,a){if(this._nowUpdating)return h.call(t,e,n,r,o,a);throw new E("Cannot mutate DepJsonCell!")},t.deleteProperty=function(e,n,r,o){if(this._nowUpdating)return d.call(t,e,n,r,o);throw new E("Cannot mutate DepJsonCell!")}}Object.defineProperty(t,"__esModule",{value:!0}),t.update=t.jsonCell=t.SrcJsonCell=t.DepJsonCell=t.DepMutationError=t.ObsJsonCell=t.UPDATE=t.patchHas=void 0,t.logReturn=function(t){return console.info(t),t},t.makeReadOnly=y;var b=i(e),v=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e}(n),_=i(r),g=i(o),w=i(a),m=i(u),j=function(){function t(t,e){var n=[],r=!0,o=!1,a=void 0;try{for(var u,i=t[Symbol.iterator]();!(r=(u=i.next()).done)&&(n.push(u.value),!e||n.length!==e);r=!0);}catch(t){o=!0,a=t}finally{try{!r&&i.return&&i.return()}finally{if(o)throw a}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),O=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),P=m.default.create({cloneDiffValues:!0}),k=v._recorder,C=t.patchHas=function t(e,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(b.default.isString(n))return t(e,n.split("."));if(!n.length)return!0;b.default.isArray(e)&&!r&&(r=!0,e=e[0]);var o=p(n),a=o[0],u=o.slice(1);if(b.default.isObject(e)){if(!r&&"a"===e._t){var i=""+a;return i in e?t(e[i],u,r):a in e&&t(e[a],u,r)}return a in e&&(1===n.length||t(e[a],u,r))}return!1},x=function(t,e){if(!t.length)return e;var n={};return(0,g.default)(n,t,e),n},A=t.UPDATE=Symbol("update"),S=t.ObsJsonCell=function(t){function e(t){f(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._base=t,n.onChange=n._mkEv(function(){return P.diff({},n._base)}),n.onUnsafeMutation=n._mkEv(function(){}),n._updating(function(){return n._data=new Proxy({value:n._base},n.conf([],null))}),n}return s(e,v.ObsBase),O(e,[{key:"_updating",value:function(t){this._oldUpdating=this._nowUpdating||!1,this._nowUpdating=!0;try{v.snap(t)}finally{this._nowUpdating=this._oldUpdating}return!0}},{key:"_update",value:function(t){var e=this;return this._updating(function(){var n=P.diff(e._data,{value:t});P.patch(e._data,n)}),!0}},{key:"all",value:function(){return this.data}},{key:"readonly",value:function(){var t=this;return new U(function(){return t.data})}},{key:"mkDeleteProperty",value:function(t,e){var n=this;return function(r,o){return n.deleteProperty(t,e,r,o)}}},{key:"mkSetProperty",value:function(t,e){var n=this;return function(r,o,a){return n.setProperty(t,e,r,o,a)}}},{key:"deleteProperty",value:function(t,e,n,r){return d.call(this,t,e,n,r)}},{key:"setProperty",value:function(t,e,n,r,o){return h.call(this,t,e,n,r,o)}},{key:"conf",value:function(t){var e=this,n=function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.concat(n)};return{deleteProperty:this.mkDeleteProperty(n,t),set:this.mkSetProperty(n,t),get:function(t,r){var o=t[r];if("__proto__"===r||b.default.isFunction(o))return o;if(r===A||"updateRxb"===r&&!("updateRxb"in t))return function(e){return P.patch(t,P.diff(t,e))};var a=n(r);if("length"===r&&b.default.isArray(t)){var u=t.length;k.sub(e.onChange,function(){var t=(0,_.default)(e._base,a.slice(1));return t!==u&&(u=t,!0)})}else k.sub(e.onChange,function(t){return C(t,a)});return b.default.isObject(o)?new Proxy(o,e.conf(n(r),t)):o},has:function(t,r){var o=n(r).slice(1),a=r in t;return k.sub(e.onChange,function(t){var n=(0,w.default)(e._base,o);return a!==n&&(a=n,!0)}),a},ownKeys:function(n){return k.sub(e.onChange,function(e){var n=(0,_.default)(e,t);return!!n&&(!!b.default.isArray(n&&2!==n.length)||"a"===n._t&&b.default.chain(n).omit("_t").values().value().some())}),Reflect.ownKeys(n)}}}},{key:"data",get:function(){return this._data.value}}]),e}(),E=t.DepMutationError=function(t){function e(){var t;f(this,e);for(var n=arguments.length,r=Array(n),o=0;o<n;o++)r[o]=arguments[o];var a=l(this,(t=e.__proto__||Object.getPrototypeOf(e)).call.apply(t,[this].concat(r)));return Error.captureStackTrace(a,e),a}return s(e,Error),e}(),U=t.DepJsonCell=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};f(this,e);var r=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n));r.f=t;var o=v.bind(r.f);return v.autoSub(o.onSet,function(t){var e=j(t,2),n=(e[0],e[1]);return r._update(n)}),y(r),r}return s(e,S),e}(),D=t.SrcJsonCell=function(t){function e(t){return f(this,e),l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t))}return s(e,S),O(e,[{key:"update",value:function(t){return this._update(t)}},{key:"data",set:function(t){this._update(t)},get:function(){return this._data.value}}]),e}();t.jsonCell=function(t){return new D(t).data},t.update=function(t,e){return v.snap(function(){var n=P.diff(t,e);return P.patch(t,n),!0})}});