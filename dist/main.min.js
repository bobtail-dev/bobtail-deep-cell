!function(e,t){if("function"==typeof define&&define.amd)define("bobtail-deep-cell",["exports","nevernull","underscore","bobtail-rx","lodash.get","lodash.set","lodash.hasin","jsondiffpatch"],t);else if("undefined"!=typeof exports)t(exports,require("nevernull"),require("underscore"),require("bobtail-rx"),require("lodash.get"),require("lodash.set"),require("lodash.hasin"),require("jsondiffpatch"));else{var n={exports:{}};t(n.exports,e.nevernull,e._,e.rx,e.lodashGet,e.lodashSet,e.lodashHasin,e.jsondiffpatch),e.bobtailDeepCell=n.exports}}(this,function(e,t,n,r,o,a,u,i){"use strict";function f(e){return e&&e.__esModule?e:{default:e}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function p(e){return Array.isArray(e)?e:Array.from(e)}Object.defineProperty(e,"__esModule",{value:!0}),e.update=e.jsonCell=e.JsonCell=e.UPDATE=e.patchHas=void 0,e.logReturn=function(e){return console.info(e),e};f(t);var h=f(n),b=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(r),v=f(o),_=f(a),y=f(u),g=f(i),j=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),w=g.default.create({cloneDiffValues:!0}),m=b._recorder,x=e.patchHas=function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(h.default.isString(n))return e(t,n.split("."));if(!n.length)return!0;h.default.isArray(t)&&!r&&(r=!0,t=t[0]);var o=p(n),a=o[0],u=o.slice(1);if(h.default.isObject(t)){if(!r&&"a"===t._t){var i=""+a;return i in t?e(t[i],u,r):a in t&&e(t[a],u,r)}return a in t&&(1===n.length||e(t[a],u,r))}return!1},O=function(e,t){if(!e.length)return t;var n={};return(0,_.default)(n,e,t),n},C=e.UPDATE=Symbol("update"),k=e.JsonCell=function(e){function t(e){s(this,t);var n=c(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._base=null!=e?e:{},n.onChange=n._mkEv(function(){return w.diff({},n._base)}),n.onUnsafeMutation=n._mkEv(function(){}),n._data=new Proxy(n._base,n.conf([],null)),n}return d(t,b.ObsBase),j(t,[{key:"del",value:function(e,t){return this.__proto__.constructor.stDel(e,t)}},{key:"set",value:function(e,t){return this.__proto__.constructor.stSet(e,t)}},{key:"update",value:function(e){var t=w.diff(this.data,e);return w.patch(this.data,t),!0}},{key:"conf",value:function(e){var t=this,n=function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.concat(n)};return{deleteProperty:function(r,o){var a=n(o);return m.stack.length>0&&(console.warn("Warning: deleting nested element at "+a.join(".")+" from within a bind context. Affected object:",r),t.onUnsafeMutation.pub({op:"delete",path:a,obj:r,prop:o,base:t._base})),m.mutating(function(){var n=r[o],a=O(e,[l({},o,n),0,0]);o in r&&(t.del(r,o),t.onChange.pub(a))}),!0},set:function(r,o,a){var u=n(o);return m.stack.length>0&&(console.warn("Warning: updating nested element at "+u.join(".")+" from within a bind context. Affected object:",r),t.onUnsafeMutation.pub({op:"set",path:u,obj:r,prop:o,val:a,base:t._base})),m.mutating(function(){var n=b.snap(function(){return r[o]}),u=w.diff(l({},o,n),l({},o,a));u&&(b.snap(function(){return w.patch(r,u)}),t.onChange.pub(O(e,u)))}),!0},get:function(e,r){var o=e[r];if("__proto__"===r||h.default.isFunction(o))return o;if(r===C||"updateRxb"===r&&!("updateRxb"in e))return function(t){return w.patch(e,w.diff(e,t))};var a=n(r);if("length"===r&&h.default.isArray(e)){var u=e.length;m.sub(t.onChange,function(){var e=(0,v.default)(t._base,a);return e!==u&&(u=e,!0)})}else m.sub(t.onChange,function(e){return x(e,a)});return h.default.isObject(o)?new Proxy(o,t.conf(n(r),e)):o},has:function(e,r){var o=n(r),a=r in e;return m.sub(t.onChange,function(e){var n=(0,y.default)(t._base,o);return a!==n&&(a=n,!0)}),a},ownKeys:function(n){return m.sub(t.onChange,function(t){var n=(0,v.default)(t,e);return!!n&&(!!h.default.isArray(n&&2!==n.length)||"a"===n._t&&h.default.chain(n).omit("_t").values().value().some())}),Reflect.ownKeys(n)}}}},{key:"data",get:function(){return this._data},set:function(e){this.update(e)}}],[{key:"stDel",value:function(e,t){return delete e[t]}},{key:"stSet",value:function(e,t,n){return e[t]=n}}]),t}();e.jsonCell=function(e){return new k(e).data},e.update=function(e,t){var n=w.diff(e,t);return w.patch(e,n),!0}});